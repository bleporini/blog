
<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">

    <title>JVM&#58; Le prix de l'immutabilité</title>
    
    <meta name="author" content="Brice LEPORINI">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

      <link href="/assets/css/tbt.css" rel="stylesheet">
      <link href="/assets/themes/bootstrap/resources/bootstrap/css/bootstrap.min.css" rel="stylesheet">
      <link href="assets/css/github.css" rel="stylesheet">

      <!--SYNTAX HIGHLIGHTER BEGINS -->
      <link href='/assets/css/shCore.css' rel='stylesheet' type='text/css'/>
      <link href='/assets/css/shThemeDefault.css' rel='stylesheet' type='text/css'/>
      <script src='/assets/js/sh/shCore.js' type='text/javascript'></script>
      <script src='/assets/js/sh/shBrushCpp.js' type='text/javascript'></script>
      <script src='/assets/js/sh/shBrushCSharp.js' type='text/javascript'></script>
      <script src='/assets/js/sh/shBrushCss.js' type='text/javascript'></script>
      <script src='/assets/js/sh/shBrushJava.js' type='text/javascript'></script>
      <script src='/assets/js/sh/shBrushJScript.js' type='text/javascript'></script>
      <script src='/assets/js/sh/shBrushPhp.js' type='text/javascript'></script>
      <script src='/assets/js/sh/shBrushPython.js' type='text/javascript'></script>
      <script src='/assets/js/sh/shBrushRuby.js' type='text/javascript'></script>
      <script src='/assets/js/sh/shBrushSql.js' type='text/javascript'></script>
      <script src='/assets/js/sh/shBrushVb.js' type='text/javascript'></script>
      <script src='/assets/js/sh/shBrushXml.js' type='text/javascript'></script>
      <script src='/assets/js/sh/shBrushPerl.js' type='text/javascript'></script>
      <script src='/assets/js/sh/shBrushScala.js' type='text/javascript'></script>
      <script src='/assets/js/sh/shBrushBash.js' type='text/javascript'></script>
      <script language='javascript'>
          SyntaxHighlighter.config.bloggerMode = true;
          SyntaxHighlighter.config.clipboardSwf = 'http://alexgorbatchev.com/pub/sh/current/scripts/clipboard.swf';
          SyntaxHighlighter.all();
      </script>

      <!--SYNTAX HIGHLIGHTER ENDS-->
  
    <!--[if lt IE 9]>
      <script src="/assets/themes/bootstrap/resources/respond/Respond.min.js"></script>
    <![endif]-->

    <link href="/atom.xml" type="application/atom+xml" rel="alternate" title="Sitewide ATOM Feed">
    <link href="/rss.xml" type="application/rss+xml" rel="alternate" title="Sitewide RSS Feed">

  </head>

  <body>
  <nav class="navbar navbar-default" role="navigation">
      <div class="container">
          <div class="navbar-header">
              <button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".navbar-ex1-collapse">
                  <span class="sr-only">Toggle navigation</span>
                  <span class="icon-bar"></span>
                  <span class="icon-bar"></span>
                  <span class="icon-bar"></span>
              </button>
              <a class="navbar-brand" href="/">The Babel Tower</a>
          </div>

          <div class="collapse navbar-collapse navbar-ex1-collapse">
              <ul class="nav navbar-nav">
                  
                  
                  


  
    
      
      	
      	<li><a href="/archive.html">Archive</a></li>
      	
      
    
  
    
      
    
  
    
  
    
      
      	
      	<li><a href="/pages.html">Pages</a></li>
      	
      
    
  
    
      
    
  
    
      
    
  
    
      
      	
      	<li><a href="/tags.html">Tags</a></li>
      	
      
    
  



              </ul>
          </div>
      </div>
  </nav>

  <div class="container">
      <div class="row">
          <div class="col-md-3 hidden-xs hidden-sm">
              <div class="well">
                  <div class="nav nav-stacked side-bar">

                      <img src="/assets/img/gravatar.jpeg" alt="gravatar">

                      <a href="https://twitter.com/blep" class="twitter-follow-button" data-show-count="false" data-lang="fr" data-size="large">Suivre @blep</a>
                      <script>!function(d,s,id){var js,fjs=d.getElementsByTagName(s)[0],p=/^http:/.test(d.location)?'http':'https';if(!d.getElementById(id)){js=d.createElement(s);js.id=id;js.src=p+'://platform.twitter.com/widgets.js';fjs.parentNode.insertBefore(js,fjs);}}(document, 'script', 'twitter-wjs');</script>

                      
                      


<ul class="post-collate-side">
  
    
    
    
    
  
    
      <li><a data-toggle="collapse" href="#ul2014">2014</a>
        <ul class="collapse post-collate-side" id="ul2014">
            <li>April
             <ul>
    
  
    <li><span>2014-04-25</span> &raquo; <a href="/2014/04/25/test-post">test post</a></li>
  
    
          
        
            </ul></li>
          <li>February</li>
          <ul>
        
      
    
  
    
    
    
    
  
    
  
    <li><span>2014-02-07</span> &raquo; <a href="/2014/02/07/XMLUnit%253A%2Bune%2Bpetite%2Blib%2Bqui%2Bd%25C3%25A9panne%2Bbien">XMLUnit&#58; une petite lib qui dépanne bien</a></li>
  
    
      
             </ul></li>
         </ul></li>
      <li><a data-toggle="collapse" href="#ul2013">2013</a>
        <ul class="collapse" id="ul2013">
            <li>August
             <ul>
      
    
  
    
    
    
    
  
    
  
    <li><span>2013-08-21</span> &raquo; <a href="/2013/08/21/JVM%253A%2BLe%2Bprix%2Bde%2Bl%2527immutabilit%25C3%25A9">JVM&#58; Le prix de l'immutabilité</a></li>
  
    
          
        
            </ul></li>
          <li>April</li>
          <ul>
        
      
    
  
    
    
    
    
  
    
  
    <li><span>2013-04-19</span> &raquo; <a href="/2013/04/19/Why%2BScala%253A%2BLa%2Bstack%2B%25282%252F2%2529">Why Scala&#58; La stack (2/2)</a></li>
  
    
          
        
            </ul></li>
          <li>March</li>
          <ul>
        
      
    
  
    
    
    
    
  
    
  
    <li><span>2013-03-31</span> &raquo; <a href="/2013/03/31/Retour%2Bsur%2BDevoxxFr%2B2013">Retour sur DevoxxFr 2013</a></li>
  
    
          
        
            </ul></li>
          <li>February</li>
          <ul>
        
      
    
  
    
    
    
    
  
    
  
    <li><span>2013-02-22</span> &raquo; <a href="/2013/02/22/Why%2BScala%253A%2BLa%2Bstack%2B%25281%252F2%2529">Why Scala&#58; La stack (1/2)</a></li>
  
    
          
        
      
    
  
    
    
    
    
  
    
  
    <li><span>2013-02-02</span> &raquo; <a href="/2013/02/02/Why%2BScala%253F">Why Scala?</a></li>
  
    
          
        
            </ul></li>
          <li>January</li>
          <ul>
        
      
    
  
    
    
    
    
  
    
  
    <li><span>2013-01-06</span> &raquo; <a href="/2013/01/06/AngularJS%2B%252B%2BPlay%2521%2BFramework%253A%2BAuthentification">AngularJS + Play! Framework&#58; Authentification</a></li>
  
    
      
             </ul></li>
         </ul></li>
      <li><a data-toggle="collapse" href="#ul2012">2012</a>
        <ul class="collapse" id="ul2012">
            <li>October
             <ul>
      
    
  
    
    
    
    
  
    
  
    <li><span>2012-10-27</span> &raquo; <a href="/2012/10/27/Taille%2Bde%2Bsession%2BHTTP">Taille de session HTTP</a></li>
  
    
          
        
            </ul></li>
          <li>August</li>
          <ul>
        
      
    
  
    
    
    
    
  
    
  
    <li><span>2012-08-10</span> &raquo; <a href="/2012/08/10/Java%2Bet%2BVMWare">Java et VMWare</a></li>
  
    
          
        
            </ul></li>
          <li>March</li>
          <ul>
        
      
    
  
    
    
    
    
  
    
  
    <li><span>2012-03-16</span> &raquo; <a href="/2012/03/16/JPA%252C%2BHibernate%2Bet%2Brequ%25C3%25AAte%2Bconstructeur">JPA, Hibernate et requête constructeur</a></li>
  
    
      
             </ul></li>
         </ul></li>
      <li><a data-toggle="collapse" href="#ul2011">2011</a>
        <ul class="collapse" id="ul2011">
            <li>May
             <ul>
      
    
  
    
    
    
    
  
    
  
    <li><span>2011-05-19</span> &raquo; <a href="/2011/05/19/Cr%25C3%25A9ation%2Bd%2527une%2Bmini%2BPKI">Création d'une mini PKI</a></li>
  
    
          
        
            </ul></li>
          <li>February</li>
          <ul>
        
      
    
  
    
    
    
    
  
    
  
    <li><span>2011-02-26</span> &raquo; <a href="/2011/02/26/MVP%2Bet%2BGWT">MVP et GWT</a></li>
  
    
          
        
      
    
  
    
    
    
    
  
    
  
    <li><span>2011-02-18</span> &raquo; <a href="/2011/02/18/Message%2BDriven%2BBean%253A%2Bconfiguration%2Bde%2Bl%2527acc%25C3%25A8s%2B%25C3%25A0%2Bune%2BDestination%2Bs%25C3%25A9curis%25C3%25A9e">Message Driven Bean&#58; configuration de l'accès à une Destination sécurisée</a></li>
  
    
          
        
      
    
  
    
    
    
    
  
    
  
    <li><span>2011-02-18</span> &raquo; <a href="/2011/02/18/MDB%253A%2Butiliser%2Bdes%2BEJB%2Bs%25C3%25A9curis%25C3%25A9s">MDB&#58; utiliser des EJB sécurisés</a></li>
  
    
          
        
      
    
  
    
    
    
    
  
    
  
    <li><span>2011-02-10</span> &raquo; <a href="/2011/02/10/Aspirer%2Bun%2Bsite%2Bavec%2Bwget">Aspirer un site avec wget</a></li>
  
    
          
        
            </ul></li>
          <li>January</li>
          <ul>
        
      
    
  
    
    
    
    
  
    
  
    <li><span>2011-01-31</span> &raquo; <a href="/2011/01/31/Maven%2BSurefire%253A%2BLancer%2Bun%2Bseul%2Btest">Maven Surefire&#58; Lancer un seul test</a></li>
  
    
          
        
      
    
  
    
    
    
    
  
    
  
    <li><span>2011-01-24</span> &raquo; <a href="/2011/01/24/Hibernate%253A%2Bvaleur%2Bdes%2Bparam%25C3%25A8tres%2Bet%2Blog">Hibernate&#58; valeur des paramètres et log</a></li>
  
    
      
             </ul></li>
         </ul></li>
      <li><a data-toggle="collapse" href="#ul2008">2008</a>
        <ul class="collapse" id="ul2008">
            <li>December
             <ul>
      
    
  
    
    
    
    
  
    
  
    <li><span>2008-12-24</span> &raquo; <a href="/2008/12/24/Windows%2Bet%2Bles%2Bvariables%2Bd%2527environnement">Windows et les variables d'environnement</a></li>
  
    
      
             </ul></li>
         </ul></li>
      <li><a data-toggle="collapse" href="#ul2007">2007</a>
        <ul class="collapse" id="ul2007">
            <li>June
             <ul>
      
    
  
    
    
    
    
  
    
  
    <li><span>2007-06-01</span> &raquo; <a href="/2007/06/01/WebServices%2BEJB%2B3%253A%2BTrop%2Bfastoche">WebServices EJB 3&#58; Trop fastoche</a></li>
  
    
          
        
            </ul></li>
          <li>May</li>
          <ul>
        
      
    
  
    
    
    
    
  
    
  
    <li><span>2007-05-09</span> &raquo; <a href="/2007/05/09/Premier">Premier</a></li>
  
    
             </ul></li>
         </ul></li>
     </ul>
    
  




                      <span style='font-size: 130%'><a href='tags.html#mdb-ref'>mdb</a></span>
<span style='font-size: 65%'><a href='tags.html#maven-ref'>maven</a></span>
<span style='font-size: 65%'><a href='tags.html#profiling-ref'>profiling</a></span>
<span style='font-size: 65%'><a href='tags.html#service-ref'>service</a></span>
<span style='font-size: 65%'><a href='tags.html#web-ref'>web</a></span>
<span style='font-size: 65%'><a href='tags.html#xml-ref'>xml</a></span>
<span style='font-size: 65%'><a href='tags.html#junit-ref'>junit</a></span>
<span style='font-size: 65%'><a href='tags.html#windows-ref'>windows</a></span>
<span style='font-size: 65%'><a href='tags.html#jvm-ref'>jvm</a></span>
<span style='font-size: 65%'><a href='tags.html#mvp-ref'>mvp</a></span>
<span style='font-size: 65%'><a href='tags.html#wget-ref'>wget</a></span>
<span style='font-size: 65%'><a href='tags.html#hibernate-ref'>hibernate</a></span>
<span style='font-size: 458%'><a href='tags.html#java-ref'>java</a></span>
<span style='font-size: 65%'><a href='tags.html#j2ee-ref'>j2ee</a></span>
<span style='font-size: 65%'><a href='tags.html#xmlunit-ref'>xmlunit</a></span>
<span style='font-size: 65%'><a href='tags.html#slick-ref'>slick</a></span>
<span style='font-size: 130%'><a href='tags.html#play-ref'>play</a></span>
<span style='font-size: 65%'><a href='tags.html#guava-ref'>guava</a></span>
<span style='font-size: 130%'><a href='tags.html#javaee-ref'>javaee</a></span>
<span style='font-size: 130%'><a href='tags.html#test-ref'>test</a></span>
<span style='font-size: 65%'><a href='tags.html#devoxxfr13-ref'>devoxxfr13</a></span>
<span style='font-size: 65%'><a href='tags.html#gc-ref'>gc</a></span>
<span style='font-size: 130%'><a href='tags.html#javascript-ref'>javascript</a></span>
<span style='font-size: 65%'><a href='tags.html#authentification-ref'>authentification</a></span>
<span style='font-size: 130%'><a href='tags.html#sécurité-ref'>sécurité</a></span>
<span style='font-size: 65%'><a href='tags.html#mutabilité-ref'>mutabilité</a></span>
<span style='font-size: 392%'><a href='tags.html#scala-ref'>scala</a></span>
<span style='font-size: 65%'><a href='tags.html#angularjs-ref'>angularjs</a></span>
<span style='font-size: 65%'><a href='tags.html#jpa-ref'>jpa</a></span>
<span style='font-size: 65%'><a href='tags.html#gwt-ref'>gwt</a></span>
<span style='font-size: 196%'><a href='tags.html#ejb-ref'>ejb</a></span>
<span style='font-size: 65%'><a href='tags.html#immutabilité-ref'>immutabilité</a></span>
<span style='font-size: 65%'><a href='tags.html#bigdata-ref'>bigdata</a></span>
<span style='font-size: 65%'><a href='tags.html#sbt-ref'>sbt</a></span>
<span style='font-size: 65%'><a href='tags.html#visualvm-ref'>visualvm</a></span>
<span style='font-size: 65%'><a href='tags.html#ssl-ref'>ssl</a></span>


                  </div>
              </div>
          </div>
          <div class="col-md-9">
              
<div class="page-header">
  <h1>JVM&#58; Le prix de l'immutabilité </h1>
</div>

<div class="row post-full">
  <div class="col-md-12">
    <div class="date">
      <span>2013-08-21</span>
    </div>
    <div class="content">
      
<p>Je l'avoue, durant mes vacances au bord de l'eau, entre les ap&eacute;ritifs et les siestes syndicales, une question est venue me chatouiller: les &eacute;vang&eacute;listes de la programmation fonctionnelle nous bassinent avec les avantages de l'immutabilit&eacute; mais au bout du compte &ccedil;a doit pas &ecirc;tre gratuit cette affaire l&agrave;? Combien &ccedil;a co&ucirc;te? Du coup je me suis fix&eacute; comme objectif pour ma rentr&eacute;e de r&eacute;unir des &eacute;l&eacute;ments permettant d'avoir un peu plus de recul sur cette question. Je vous propose de suivre ma d&eacute;marche dans ce billet. </p> 
<p>Tout d'abord, rappelons que la principale vertu de l'immutabilit&eacute; est qu'un objet non modifiable peut &ecirc;tre acc&eacute;d&eacute; par plusieurs threads sans n&eacute;cessiter de verrouillage, permettant d'exclure toute situation de comp&eacute;tition (race condition) sur une ressource. Il semble que cela soit une des clefs permettant de passer de la gestion de la concurrence au parall&eacute;lisme. Soit, toutefois les valeurs d'un objet doivent parfois &ecirc;tre modifi&eacute;es, impliquant la cr&eacute;ation d'une nouvelle entit&eacute; immuable avec la ou les nouvelle(s) valeur(s), l'allocation d'une nouvelle instance et potentiellement la collecte de l'ancienne. C'est pr&eacute;cis&eacute;ment ces effets de bord qui retiennent mon attention. </p> 
<p> Le POC prend la forme de tests unitaires dans lesquels tous les objets d'une liste sont modifi&eacute;s: une case class comprenant un membre unique de type Long et l'op&eacute;ration appliqu&eacute;e est l'ajout du nombre de nanosecondes contenue dans une journ&eacute;e. La situation est observ&eacute;e sous deux angles diff&eacute;rents: l'objet est modifiable et sa variable d'instance est mise &agrave; jour ou l'objet est immuable et une nouvelle entit&eacute; est cr&eacute;&eacute;e. Le langage est Scala, le code est trivial et vous pouvez le trouver les d&eacute;tails sur Github (<a href="https://github.com/bleporini/immutabilityCost">https://github.com/bleporini/immutabilityCost</a>). </p> 
<p> Les classes: </p> 
<pre class="brush: scala;  ">  case class Immutable(date:Long)<br />  case class Mutable(var date:Long)<br /></pre> Les fonctions de modification: 
<pre class="brush: scala;  ">    def addOneDay(from:Immutable):Immutable= Immutable(from.date+oneDayNs)<br /><br />    def addOneDay(from:Mutable):Mutable={<br />      from.date = from.date + oneDayNs<br />      from<br />    }<br /></pre> L'application des fonctions: 
<pre class="brush: scala;  ">mo /*la liste*/ map transformer /* la foncntion modifiante */</pre> 
<h3>Le probl&egrave;me du micro benchmark</h3> 
<p>Le programme s'ex&eacute;cute sur la JVM, un environnement d'ex&eacute;cution &quot;manag&eacute;&quot;, c'est &agrave; dire qu'en plus de faire le m&eacute;nage dans la m&eacute;moire (Garbage Collection), la machine virtuelle, et plus particuli&egrave;rement le JIT (Just In Time compiler), r&eacute;alise plein de choses &agrave; l'insu de notre plein gr&eacute; &agrave; des fins d'optimisations, comme compiler du bytecode en code natif et l'int&eacute;grer dans les piles d'appel (OSR), &quot;inliner&quot; des m&eacute;thodes, etc. Ce comportement peut contribuer de fa&ccedil;on importante dans la difficult&eacute; &agrave; obtenir des temps d'ex&eacute;cution r&eacute;p&eacute;tables. </p> 
<p>Il ne me semble pas opportun de proc&eacute;der &agrave; un param&eacute;trage hasardeux visant &agrave; stabiliser les r&eacute;sultats. Mon approche s'at&egrave;le plut&ocirc;t &agrave; observer le comportement de la JVM lors de l'ex&eacute;cution en boucle du test pour d&eacute;terminer quand les manipulations sur le code sont stabilis&eacute;es et les temps mesur&eacute;s sont &agrave; peu pr&egrave;s constants. En gros le chrono est d&eacute;clench&eacute; quand la JVM est &quot;chaude&quot;. </p> 
<p>En ce qui concerne le GC, je m'assure simplement en analysant les logs produits par le param&egrave;tre -XX:+PrintGCDetails qu'il n'y a pas de collecte compl&egrave;te qui pourrait fausser les r&eacute;sultats. </p> 
<p>Du c&ocirc;t&eacute; de la manipulation de code, une ex&eacute;cution verbeuse (&eacute;tat d'avancement sur la sortie standard) du test en boucle conjugu&eacute;e &agrave; l'affichage des informations de compilation (-XX:+PrintCompilation) me permet de visualiser &agrave; partir de quand le code n'est plus manipul&eacute;. Dans le cas &eacute;tudi&eacute; il faut moins d'une centaine d'it&eacute;ration pour que JIT calme ses ardeurs (les 700 premi&egrave;res manipulations vous sont graci&eacute;es…): </p> 
<p> </p> 
<pre class="brush: bash;  "><br />[…]<br />    704   75             scala.collection.Iterator$class::foreach (26 bytes)<br />    704   65             scala.collection.TraversableLike$$anonfun$map$1::apply (6 bytes)   made not entrant<br />    704   66             scala.collection.TraversableLike$$anonfun$map$1::apply (20 bytes)   made not entrant<br />    711   76             blep.ImmutabilityTest$$anonfun$1$$anonfun$bencher$1$1::apply (9 bytes)<br />    711   77             blep.ImmutabilityTest$$anonfun$1$$anonfun$bencher$1$1::apply (9 bytes)<br />    713   78             blep.ImmutabilityTest$$anonfun$1::blep$ImmutabilityTest$$anonfun$$addOneDay$1 (23 bytes)<br />    713   79             blep.ImmutabilityTest$Immutable::date (5 bytes)<br />    713   80             blep.package$::oneDayNs (5 bytes)<br />    714   81             scala.collection.TraversableLike$$anonfun$map$1::apply (6 bytes)<br />    714   82             scala.collection.TraversableLike$$anonfun$map$1::apply (20 bytes)<br />    720   83             java.lang.StringBuilder::append (8 bytes)<br />0 nth time: 15316 us<br />    723   84             scala.collection.immutable.VectorBuilder::display1 (5 bytes)<br />    724   85             scala.collection.immutable.VectorBuilder::depth (5 bytes)<br />    724   86             scala.collection.immutable.VectorBuilder::display0_$eq (6 bytes)<br />    724   87             scala.collection.immutable.VectorPointer$class::gotoNextBlockStartWritable (757 bytes)<br />    728   88             scala.collection.immutable.VectorIterator::display0_$eq (6 bytes)<br />    729   89             scala.collection.immutable.VectorPointer$class::gotoNextBlockStart (336 bytes)<br />    752   90             scala.collection.immutable.VectorIterator::display1 (5 bytes)<br />100 nth time: 1423 us<br />200 nth time: 1394 us<br />300 nth time: 2639 us<br />400 nth time: 1362 us<br />500 nth time: 1369 us<br />600 nth time: 1419 us<br /></pre> Le calibrage issu de ces informations conduisent &agrave; effectuer l'exp&eacute;rimentation dans les conditions suivantes: la liste comprend 100000 &eacute;l&eacute;ments, l'application de la modification est effectu&eacute;e 10000 fois sur la liste, chaque it&eacute;ration est chronom&eacute;tr&eacute;e et une moyenne globale plus une sur les 100 derni&egrave;res sont calcul&eacute;es. C'est un peu bourrin, mais cela permet de g&eacute;n&eacute;rer des r&eacute;sultats assez stables. 
<p></p> 
<p>Dernier d&eacute;tail, il est &eacute;videmment important que le lanceur (SBT) &quot;forke&quot; la JVM pour les tests, il serait ballot que le comportement soit parasit&eacute; par l'outil de build... </p> 
<p> Je n'ai pas tenu compte des potentielles probl&eacute;matiques li&eacute;es au cache L1/L2/L3 du socle mat&eacute;riel, si quelqu'un sait comment r&eacute;colter ce genre d'informations sur Mac, merci de contribuer! </p> 
<p> La partie la plus &quot;velue&quot; aura &eacute;t&eacute; d'ajuster les param&egrave;tres de lancement dans SBT (S pour simple, vous &ecirc;tes s&ucirc;rs?). </p> 
<h3>Les r&eacute;sultats</h3> 
<p>Venons en aux chiffres: </p> 
<table class="table"> 
 <tbody> 
  <tr> 
   <th>M&eacute;thode</th> 
   <th>It&eacute;rations</th> 
   <th>Max</th> 
   <th>Min</th> 
   <th>Moy</th> 
   <th>Moy(100)</th> 
   <th>GC Pauses</th> 
   <th>Pauses Tot</th> 
   <th>FGC Pauses</th> 
  </tr> 
  <tr> 
   <td>Mutable</td> 
   <td>10000</td> 
   <td>34620</td> 
   <td>951</td> 
   <td>2505</td> 
   <td>1111</td> 
   <td>66</td> 
   <td>0,52</td> 
   <td>0</td> 
  </tr> 
  <tr> 
   <td>Immutable</td> 
   <td>10000</td> 
   <td>45160</td> 
   <td>1137</td> 
   <td>4327</td> 
   <td>1417</td> 
   <td>126</td> 
   <td>1,76</td> 
   <td>0</td> 
  </tr> 
  <tr> 
   <td></td> 
   <td></td> 
   <td>30 % </td> 
   <td>20 % </td> 
   <td>73 % </td> 
   <td>28 % </td> 
   <td>91 % </td> 
   <td>238 %</td> 
   <td></td> 
  </tr> 
 </tbody> 
</table> 
<p>Ce n'est donc pas une surprise, comparativement, le GC ramasse : il se d&eacute;clenche deux fois plus pour le m&ecirc;me travail et g&eacute;n&egrave;re 3,4 fois plus de temps de pauses quand le traitement engendre de nouvelles entit&eacute;s &agrave; chaque modification. </p> 
<p> Mais au fond, le r&eacute;sultat qui m'int&eacute;resse le plus est la diff&eacute;rence au niveau du temps d'ex&eacute;cution, le nerf de la guerre, l'immutabilit&eacute; dure &agrave; priori pas loin de 30% plus longtemps. Voil&agrave;, tu t'es fait attir&eacute; sur cet article au titre tendance, tu as suivi un geek qui fait mumuse avec des additions pour arriver &agrave; la conclusion que g&eacute;n&eacute;rer plus de travail prend plus de temps… tu peux retourner voir si les specs de l'iPhone 6 n'ont pas fuit&eacute;! </p> 
<p> Plus s&eacute;rieusement, le temps d'ex&eacute;cution &eacute;tant la finalit&eacute; principale &agrave; mon sens, que peut-on tirer de ce chiffre de 30%? </p> 
<p> 30% d'augmentation du taux de ch&ocirc;mage c'est consid&eacute;rable et c'est une catastrophe, 30% d'augmentation de salaire, &ccedil;a change la vie. En revanche un ordinateur 30% plus puissant qu'un autre &ccedil;a fait pas une grosse diff&eacute;rence &agrave; l'utilisation et mon avis est que ce constat se transpose aux programmes informatiques. Je m'explique: quand je clique sur un bouton, que l'appli web r&eacute;ponde en 100ms ou 130ms, c'est rapide pourtant il y a 30% d'&eacute;cart; si au contraire quand je clique et que la r&eacute;ponse arrive au bout de 10 min ou 13 min, &ccedil;a rame la mort dans les deux cas! Donc 30% ce n'est pas n&eacute;gligeable mais cela ne nous fait pas changer de classification: on ne passe pas de &quot;&ccedil;a se tra&icirc;ne&quot; &agrave; &quot;&ccedil;a envoie du bois&quot;. </p> 
<p> Peut-on d&egrave;s lors troller qu'adopter l'immutabilit&eacute; entra&icirc;ne 30% de d&eacute;gradations sur les temps d'ex&eacute;cution? Je vois d&eacute;j&agrave; le tweet ravageur: </p> 
<p> <a href="http://2.bp.blogspot.com/-c--WzkZj8-A/UhOnXuIZ_5I/AAAAAAAABEo/2yhxO1bpc-w/s1600/fake_tweet.png" imageanchor="1"><img border="0" src="/assets/img/JVM+Le+prix+de+l_immutabilite/fake_tweet.png" /></a></p> 
<p> D'une part, l'exp&eacute;rimentation zoome sur un point particulier et la diff&eacute;rence entre les deux zones mesur&eacute;es se r&eacute;sume &agrave; &quot;allocation d'un Long et l'addition de deux Long&quot; contre &quot;allocation d'une instance de case class, d'un Long et addition de deux Long&quot;. Le trait est forc&eacute;ment grossi. </p> 
<p>D'autre part, dans la plupart des applications, beaucoup plus de temps est potentiellement consomm&eacute; dans les I/O (r&eacute;seau ou disque), dans l'interrogation des syst&egrave;mes de persistance, ou encore lors de la g&eacute;n&eacute;ration de vue ou de r&eacute;ponses, etc que dans l'allocation et la collecte. Dans la vraie vie, le gain de 30% n'est &eacute;videmment pas global. </p> 
<p>De plus, si les entit&eacute;s mutables de votre application sont partag&eacute;es entre plusieurs threads, vous &ecirc;tes vou&eacute;s &agrave; recourir &agrave; l'utilisation de moniteurs pour synchroniser les acc&egrave;s (autant en lecture qu'en &eacute;criture), du coup le temps gagn&eacute; sur l'immutabilit&eacute; peut ais&eacute;ment &ecirc;tre perdu, surtout que la programmation concurrente est souvent mal ma&icirc;tris&eacute;e. </p> 
<p>Sans compter que si des copies d&eacute;fensives (&ccedil;a m'arrive jamais…) doivent s&eacute;curiser l'acc&egrave;s aux membres de vos classes, l'inconv&eacute;nient de la gestion de la concurrence sera cumul&eacute; avec celui des allocations et collectes induites par les duplications d'objets... </p> 
<p> Compte tenu de ces donn&eacute;es, mon opinion est que l'immutabilit&eacute; co&ucirc;te certes plus, mais dans la plupart des situations la charge suppl&eacute;mentaire induite ne sera gu&egrave;re perceptible, sauf si vous avez la chance de travailler sur une application extr&ecirc;mement exigeante dans laquelle la moindre latence est chass&eacute;e, telle q'un automate temps r&eacute;el… </p>

    </div>

    

    
      <ul class="tag_box inline">
        
        


  
     
    		<span class="glyphicon glyphicon-tags"></span>
<li><a href="/tags.html#jvm-ref">jvm</a></li>
     
    		<span class="glyphicon glyphicon-tags"></span>
<li><a href="/tags.html#immutabilité-ref">immutabilité</a></li>
     
    		<span class="glyphicon glyphicon-tags"></span>
<li><a href="/tags.html#scala-ref">scala</a></li>
     
    		<span class="glyphicon glyphicon-tags"></span>
<li><a href="/tags.html#mutabilité-ref">mutabilité</a></li>
     
    		<span class="glyphicon glyphicon-tags"></span>
<li><a href="/tags.html#gc-ref">gc</a></li>
    
  



      </ul>
    

      <a href="https://twitter.com/share" class="twitter-share-button" data-via="blep">Tweet</a>
      <script>!function(d,s,id){var js,fjs=d.getElementsByTagName(s)[0],p=/^http:/.test(d.location)?'http':'https';if(!d.getElementById(id)){js=d.createElement(s);js.id=id;js.src=p+'://platform.twitter.com/widgets.js';fjs.parentNode.insertBefore(js,fjs);}}(document, 'script', 'twitter-wjs');</script>

      <!-- Placez cette balise où vous souhaitez faire apparaître le gadget Bouton +1. -->
      <div class="g-plusone"></div>

      <!-- Placez cette ballise après la dernière balise Bouton +1. -->
      <script type="text/javascript">
          window.___gcfg = {lang: 'fr'};

          (function() {
              var po = document.createElement('script'); po.type = 'text/javascript'; po.async = true;
              po.src = 'https://apis.google.com/js/platform.js';
              var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(po, s);
          })();
      </script>

    <hr>
    
    <ul class="pagination">
      
        <li class="prev"><a href="/2013/04/19/Why%2BScala%253A%2BLa%2Bstack%2B%25282%252F2%2529" title="Why Scala&#58; La stack (2/2)">&larr; Précédent</a></li>
      
        <li><a href="/archive.html">Archive</a></li>
      
        <li class="next"><a href="/2014/02/07/XMLUnit%253A%2Bune%2Bpetite%2Blib%2Bqui%2Bd%25C3%25A9panne%2Bbien" title="XMLUnit&#58; une petite lib qui dépanne bien">Suivant &rarr;</a></li>
      
    </ul>
    <hr>
    


  <div id="disqus_thread"></div>
<script type="text/javascript">
    var disqus_developer = 1;
    var disqus_shortname = 'jekyllbootstrap'; // required: replace example with your forum shortname
    
    /* * * DON'T EDIT BELOW THIS LINE * * */
    (function() {
        var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
        dsq.src = 'http://' + disqus_shortname + '.disqus.com/embed.js';
        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    })();
</script>
<noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
<a href="http://disqus.com" class="dsq-brlink">blog comments powered by <span class="logo-disqus">Disqus</span></a>




  </div>
</div>



          </div>
      </div>


      <hr>
      <footer>
          <p>
              &copy; 2014 Brice LEPORINI
          <span class="pull-right text-muted">
            powered by
            <a href="http://dbtek.github.io/jekyll-bootstrap-3" target="_blank" title="The Definitive Jekyll Blogging Framework">Jekyll-Bootstrap-3</a>
            and <a href="http://getbootstrap.com" target="_blank">Twitter Bootstrap 3.0.3</a>
          </span>
          </p>
      </footer>
  </div>


    

    <script src="/assets/themes/bootstrap/resources/jquery/jquery.min.js"></script>
    <script src="/assets/themes/bootstrap/resources/bootstrap/js/bootstrap.min.js"></script>
  </body>
</html>

